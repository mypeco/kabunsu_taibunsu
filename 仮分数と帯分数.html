<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªÆÂàÜÊï∞„Å®Â∏ØÂàÜÊï∞Ôºà„ÉÜ„Ç≠„Çπ„ÉàËøΩÂä†ÁâàÔºâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f0f9ff;
        }
        /* Custom styles for inputs to look friendly */
        .drill-input {
            text-align: center;
            font-weight: 900;
            color: #4f46e5;
            transition: all 0.2s;
        }
        .drill-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }
        /* Error state for inputs */
        .drill-input.error {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
            color: #b91c1c;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Confetti Effect Component (Simple) ---
        const Confetti = () => {
            return (
                <div className="fixed inset-0 pointer-events-none flex justify-center items-start overflow-hidden z-50">
                    <div className="mt-20 text-6xl font-black text-yellow-400 animate-bounce drop-shadow-lg" style={{textShadow: '2px 2px 0 #ea580c'}}>
                        „Åõ„ÅÑ„Åã„ÅÑÔºÅüéâ
                    </div>
                </div>
            );
        };

        // --- NumberLine Component (0 to 2) ---
        const NumberLine = ({ value, denominator, mode }) => {
            const max = 2; // Range 0 to 2
            
            const renderMarkers = () => {
                const markers = [];
                const totalSteps = denominator * max;
                
                for (let i = 0; i <= totalSteps; i++) {
                    const pos = (i / totalSteps) * 100;
                    const currentValue = i / denominator;
                    const isInteger = i % denominator === 0;
                    
                    let label = "";
                    if (isInteger) {
                        label = <span className="text-xs md:text-sm font-bold text-slate-600 mt-1">{currentValue}</span>;
                    }

                    markers.push(
                        <div 
                            key={i} 
                            className="absolute flex flex-col items-center group" 
                            style={{ left: `${pos}%`, transform: 'translateX(-50%)' }}
                        >
                            <div className={`w-px ${isInteger ? 'h-4 bg-slate-400' : 'h-2 bg-slate-300'} mb-1`}></div>
                            <div>{label}</div>
                        </div>
                    );
                }
                return markers;
            };

            const renderTopLabels = () => {
                const labels = [];
                const createLabel = (num, den, positionPercent, key) => (
                    <div 
                        key={key} 
                        className="absolute top-0 flex flex-col items-center justify-end h-10 -ml-6 w-12" 
                        style={{ left: `${positionPercent}%` }}
                    >
                        <div className="flex flex-col items-center leading-none text-xs font-bold text-indigo-500 bg-white/60 px-1 rounded backdrop-blur-[1px]">
                            <span className="border-b border-indigo-400 px-1 mb-0.5">{num}</span>
                            <span>{den}</span>
                        </div>
                        <div className="w-px h-2 bg-indigo-300/50 mt-1"></div>
                    </div>
                );

                const pos1 = (1 / (denominator * max)) * 100;
                labels.push(createLabel(1, denominator, pos1, 'first'));

                const posInt = (denominator / (denominator * max)) * 100;
                labels.push(createLabel(denominator, denominator, posInt, 'integer'));

                return labels;
            };

            // Dynamic styles for the progress bar
            const getBarStyle = () => {
                // If in mixed mode and value is at least 1, color the integer part orange
                if (mode === 'mixed' && value >= 1) {
                    const integerWidthPercent = (1 / value) * 100;
                    // Orange for the first part (integer), Indigo for the rest
                    return {
                        background: `linear-gradient(to right, #f97316 ${integerWidthPercent}%, #f97316 ${integerWidthPercent}%, #4f46e5 ${integerWidthPercent}%, #4f46e5 100%)`
                    };
                }
                // Default indigo
                return { backgroundColor: '#4f46e5' };
            };

            return (
                <div className="w-full relative px-2">
                    <div className="relative pt-10 pb-8">
                        {renderTopLabels()}
                        <div className="h-4 w-full bg-slate-100 rounded-full overflow-hidden relative border border-slate-200 shadow-inner">
                            <div className="absolute inset-0 pointer-events-none">
                                {Array.from({length: denominator * max - 1}).map((_, i) => (
                                    <div 
                                        key={i} 
                                        className={`h-full w-px z-10 absolute ${((i+1) % denominator === 0) ? 'bg-slate-300' : 'bg-white/50'}`}
                                        style={{ left: `${((i+1)/(denominator * max))*100}%` }}
                                    />
                                ))}
                            </div>
                            <div 
                                className="h-full transition-all duration-700 ease-out relative"
                                style={{ 
                                    width: `${(value / max) * 100}%`,
                                    ...getBarStyle()
                                }}
                            >
                                <div className="absolute inset-0 bg-white/10 opacity-30"></div>
                            </div>
                        </div>
                        <div 
                            className="absolute top-10 transition-all duration-700 ease-out z-20 flex items-center justify-center h-4"
                            style={{ left: `${(value / max) * 100}%`, transform: 'translateX(-50%)' }}
                        >
                            <div className="w-4 h-4 rounded-full bg-indigo-600 shadow-lg border-2 border-white transform hover:scale-110 transition-transform"></div>
                        </div>
                        <div className="relative w-full z-10 mt-1">
                            {renderMarkers()}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PizzaChart Component ---
        const PizzaChart = ({ filled, total, color, label }) => {
            const slices = useMemo(() => {
                if (total === 1) {
                    return [
                        <circle key="full" cx="50" cy="50" r="45" fill={filled >= 1 ? color : '#f1f5f9'} stroke="#fff" strokeWidth="1.5" />
                    ];
                }
                const paths = [];
                const radius = 45;
                const center = 50;
                for (let i = 0; i < total; i++) {
                    const startAngle = (i * 360) / total - 90;
                    const endAngle = ((i + 1) * 360) / total - 90;
                    const x1 = center + radius * Math.cos((startAngle * Math.PI) / 180);
                    const y1 = center + radius * Math.sin((startAngle * Math.PI) / 180);
                    const x2 = center + radius * Math.cos((endAngle * Math.PI) / 180);
                    const y2 = center + radius * Math.sin((endAngle * Math.PI) / 180);
                    const largeArc = 360 / total > 180 ? 1 : 0;
                    const d = `M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
                    
                    paths.push(
                        <path key={i} d={d} fill={i < filled ? color : '#f1f5f9'} stroke="#fff" strokeWidth="1.5" className="transition-all duration-500" />
                    );
                }
                return paths;
            }, [filled, total, color]);

            return (
                <div className="flex flex-col items-center gap-1">
                    <div className="w-20 h-20 md:w-24 md:h-24 relative bg-white rounded-full shadow-md border-2 border-indigo-50 p-1">
                        <svg viewBox="0 0 100 100" className="w-full h-full">
                            <circle cx="50" cy="50" r="46" fill="#f8fafc" />
                            {slices}
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" strokeWidth="1" />
                        </svg>
                    </div>
                    {label && <span className="text-xs font-bold text-slate-400">{label}</span>}
                </div>
            );
        };

        // --- App Component ---
        const App = () => {
            // Game State
            const [problem, setProblem] = useState({ n: 3, d: 2 });
            const [status, setStatus] = useState('thinking'); 
            const [errorFields, setErrorFields] = useState({});
            
            const [mode, setMode] = useState('improper');

            const [inputs, setInputs] = useState({
                improperN: '',
                improperD: '',
                mixedI: '',
                mixedN: '',
                mixedD: ''
            });

            const generateProblem = () => {
                const d = Math.floor(Math.random() * 9) + 2; 
                const minN = d; 
                const maxN = d * 2;
                const n = Math.floor(Math.random() * (maxN - minN + 1)) + minN;
                
                setProblem({ n, d });
                setInputs({ improperN: '', improperD: '', mixedI: '', mixedN: '', mixedD: '' });
                setStatus('thinking');
                setErrorFields({});
            };

            useEffect(() => {
                generateProblem();
            }, []);

            const handleModeChange = (newMode) => {
                setMode(newMode);
                setStatus('thinking');
                setErrorFields({});
            };

            const checkAnswer = () => {
                const { n, d } = problem;
                
                const inp_imp_n = parseInt(inputs.improperN);
                const inp_imp_d = parseInt(inputs.improperD);
                
                const inp_mix_i = inputs.mixedI === '' ? 0 : parseInt(inputs.mixedI);
                const inp_mix_n = inputs.mixedN === '' ? 0 : parseInt(inputs.mixedN);
                const inp_mix_d = inputs.mixedD === '' ? 1 : parseInt(inputs.mixedD); 

                const correctI = Math.floor(n / d);
                const correctRemN = n % d;
                
                const errors = {};

                // --- MODE DEPENDENT VALIDATION ---
                if (mode === 'improper') {
                    if (isNaN(inp_imp_n) || inp_imp_n !== n) errors.improperN = true;
                    if (isNaN(inp_imp_d) || inp_imp_d !== d) errors.improperD = true;
                } else {
                    // Mixed Mode Logic
                    if (correctRemN === 0) {
                        if (inp_mix_i !== correctI) errors.mixedI = true;
                        if (inputs.mixedN !== '' && inp_mix_n !== 0) errors.mixedN = true;
                    } else {
                        if (inp_mix_i !== correctI) errors.mixedI = true;
                        if (isNaN(inp_mix_n) || inp_mix_n !== correctRemN) errors.mixedN = true;
                        if (isNaN(inp_mix_d) || inp_mix_d !== d) errors.mixedD = true;
                    }
                }

                setErrorFields(errors);

                if (Object.keys(errors).length === 0) {
                    setStatus('correct');
                } else {
                    setStatus('incorrect');
                }
            };

            const handleInputChange = (field, value) => {
                setInputs(prev => ({ ...prev, [field]: value }));
                if (status !== 'thinking') {
                    setStatus('thinking');
                    setErrorFields({});
                }
            };

            const value = problem.n / problem.d;
            const pizza1Slices = value >= 1 ? problem.d : problem.n;
            const pizza2Slices = value > 1 ? problem.n - problem.d : 0;

            const getInputClass = (field, baseClass) => {
                if (errorFields[field]) {
                    return `${baseClass} error`;
                }
                return baseClass;
            };

            // Colors for Pizza
            // If in mixed mode, the first full pizza (integer part) should match the strong orange theme
            const pizza1Color = mode === 'mixed' ? '#f97316' : '#4f46e5'; 
            const pizza2Color = '#4f46e5';

            return (
                <div className="min-h-screen p-4 flex flex-col items-center bg-slate-50 relative justify-center">
                    {status === 'correct' && <Confetti />}

                    <header className="w-full max-w-5xl mb-6 text-center flex flex-col items-center gap-4">
                        <h1 className="text-xl md:text-3xl font-black text-slate-800">
                            ‰ªÆÂàÜÊï∞(„Åã„Å∂„Çì„Åô„ÅÜ)„Å®Â∏ØÂàÜÊï∞(„Åü„ÅÑ„Å∂„Çì„Åô„ÅÜ)
                        </h1>
                        
                        {/* MODE SWITCHER */}
                        <div className="flex justify-center gap-2 bg-white p-1.5 rounded-full shadow-sm inline-flex border border-slate-200">
                            <button 
                                onClick={() => handleModeChange('improper')}
                                className={`px-4 py-1.5 rounded-full text-sm font-bold transition-all ${mode === 'improper' ? 'bg-blue-500 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                ‰ªÆÂàÜÊï∞
                            </button>
                            <button 
                                onClick={() => handleModeChange('mixed')}
                                className={`px-4 py-1.5 rounded-full text-sm font-bold transition-all ${mode === 'mixed' ? 'bg-orange-500 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}
                            >
                                Â∏ØÂàÜÊï∞
                            </button>
                        </div>
                    </header>

                    {/* MAIN CARD - Wider and Horizontal Layout on Desktop */}
                    <div className="w-full max-w-5xl bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200 flex flex-col md:flex-row">
                        
                        {/* Left Column: Visual Area (Pizza & NumberLine) */}
                        <div className="md:w-7/12 bg-indigo-50 p-6 flex flex-col justify-center items-center gap-6 border-b md:border-b-0 md:border-r border-indigo-100">
                            
                            {/* Instruction Text */}
                            <div className="text-indigo-800 font-bold text-lg bg-white/50 px-4 py-1 rounded-full border border-indigo-100/50">
                                „Éî„Ç∂„ÅØ‰ΩïÊûöÂàÜÔºüÂàÜÊï∞„ÅßËÄÉ„Åà„Çà„ÅÜÔºÅ
                            </div>

                            <div className="flex items-center justify-center gap-4 md:gap-8">
                                <PizzaChart filled={pizza1Slices} total={problem.d} color={pizza1Color} label="1ÊûöÁõÆ" />
                                <PizzaChart filled={pizza2Slices} total={problem.d} color={pizza2Color} label="2ÊûöÁõÆ" />
                            </div>
                            <div className="w-full max-w-lg px-2">
                                <NumberLine value={value} denominator={problem.d} mode={mode} />
                            </div>
                        </div>

                        {/* Right Column: Answer & Action Area */}
                        <div className="md:w-5/12 p-6 md:p-8 bg-white flex flex-col items-center justify-center min-h-[300px]">
                            
                            {/* Input Form */}
                            <div className="w-full max-w-xs mb-8">
                                {mode === 'improper' ? (
                                    /* IMPROPER MODE INPUT */
                                    <div className="flex flex-col items-center p-6 bg-blue-50 rounded-2xl border-2 border-blue-100 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                        <h2 className="text-lg font-bold text-blue-800 mb-4 bg-white px-4 py-1 rounded-full shadow-sm">
                                            ‰ªÆÂàÜÊï∞Ôºà„Åã„Å∂„Çì„Åô„ÅÜÔºâ„ÅØÔºü
                                        </h2>
                                        <div className="flex flex-col items-center gap-2">
                                            <input 
                                                type="number" 
                                                className={getInputClass('improperN', "drill-input w-20 h-16 text-3xl bg-white border-2 border-blue-200 rounded-xl")}
                                                placeholder="?"
                                                value={inputs.improperN}
                                                onChange={(e) => handleInputChange('improperN', e.target.value)}
                                            />
                                            <div className="w-24 h-1 bg-blue-800 rounded-full"></div>
                                            <input 
                                                type="number" 
                                                className={getInputClass('improperD', "drill-input w-20 h-16 text-3xl bg-white border-2 border-blue-200 rounded-xl")}
                                                placeholder="?"
                                                value={inputs.improperD}
                                                onChange={(e) => handleInputChange('improperD', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                ) : (
                                    /* MIXED MODE INPUT */
                                    <div className="flex flex-col items-center p-6 bg-orange-50 rounded-2xl border-2 border-orange-100 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                        <h2 className="text-lg font-bold text-orange-800 mb-4 bg-white px-4 py-1 rounded-full shadow-sm">
                                            Â∏ØÂàÜÊï∞Ôºà„Åü„ÅÑ„Å∂„Çì„Åô„ÅÜÔºâ„ÅØÔºü
                                        </h2>
                                        <div className="flex items-center gap-3">
                                            <div className="flex flex-col justify-center h-full pt-1">
                                                <input 
                                                    type="number" 
                                                    // Increased border width and used strong orange
                                                    className={getInputClass('mixedI', "drill-input w-24 h-24 text-4xl bg-white border-4 border-orange-500 rounded-xl font-bold")}
                                                    placeholder="Êï¥Êï∞"
                                                    value={inputs.mixedI}
                                                    onChange={(e) => handleInputChange('mixedI', e.target.value)}
                                                />
                                            </div>
                                            <div className="flex flex-col items-center gap-2">
                                                <input 
                                                    type="number" 
                                                    className={getInputClass('mixedN', "drill-input w-16 h-14 text-2xl bg-white border-2 border-orange-200 rounded-xl")}
                                                    placeholder="?"
                                                    value={inputs.mixedN}
                                                    onChange={(e) => handleInputChange('mixedN', e.target.value)}
                                                />
                                                <div className="w-20 h-1 bg-orange-800 rounded-full"></div>
                                                <input 
                                                    type="number" 
                                                    className={getInputClass('mixedD', "drill-input w-16 h-14 text-2xl bg-white border-2 border-orange-200 rounded-xl")}
                                                    placeholder="?"
                                                    value={inputs.mixedD}
                                                    onChange={(e) => handleInputChange('mixedD', e.target.value)}
                                                />
                                            </div>
                                        </div>
                                        <p className="mt-4 text-xs text-orange-600 font-bold bg-white/50 px-2 py-1 rounded">‚ÄªÊï¥Êï∞„Å†„Åë„ÅÆ„Å®„Åç„ÅØ„ÄÅÂàÜÊï∞„ÅØÁ©∫Ê¨Ñ(„Åè„ÅÜ„Çâ„Çì)„Åß„ÅÑ„ÅÑ„Çà</p>
                                    </div>
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div className="flex flex-col items-center justify-center gap-3 w-full">
                                {status === 'incorrect' && (
                                    <div className="text-red-500 font-bold animate-pulse text-sm mb-2">
                                        Ëµ§Êû†(„ÅÇ„Åã„Çè„Åè)„ÅÆ„Å®„Åì„Çç„ÇíÁõ¥„Åù„ÅÜ ü§î
                                    </div>
                                )}
                                
                                {status === 'correct' ? (
                                    <button 
                                        onClick={generateProblem}
                                        className="w-full max-w-xs bg-green-500 hover:bg-green-600 text-white font-black text-xl py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2 animate-bounce"
                                    >
                                        „Å§„Åé„ÅÆÂïèÈ°å„Å∏ÔºÅ ‚û°
                                    </button>
                                ) : (
                                    <button 
                                        onClick={checkAnswer}
                                        className="w-full max-w-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg py-3 px-8 rounded-full shadow-lg transform active:scale-95 transition-all"
                                    >
                                        Á≠î„ÅàÂêà„Çè„Åõ
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>